<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <link rel="stylesheet" href="./index.css">
		<script src="../js/goeasy-2.6.6.min.js"></script>
    </head>
    <body>
        <div class="talk" >
            <div class="title" id="title">
                聊天室——————————————2302班聊天室
            </div>

            <div class="talk_con" id="talk_con">
                <div class="talk_show" id="words" style="overflow: scroll;">
                    <!-- 放聊天内容的地方 -->
                </div>
                <div id="image_list" style="display:none">
                    <img src="./image/1.gif" alt="" class="image_con">
                    <img src="./image/2.gif" alt="" class="image_con">
                    <img src="./image/3.gif" alt="" class="image_con">
                    <img src="./image/4.gif" alt="" class="image_con">
                    <img src="./image/5.gif" alt="" class="image_con">
                    <img src="./image/6.gif" alt="" class="image_con">
                    <img src="./image/7.gif" alt="" class="image_con">
                    <img src="./image/8.gif" alt="" class="image_con">
                    <img src="./image/9.gif" alt="" class="image_con">
                    <img src="./image/10.gif" alt="" class="image_con">
                    <img src="./image/11.gif" alt="" class="image_con">
                    <img src="./image/12.gif" alt="" class="image_con">
                    <img src="./image/13.gif" alt="" class="image_con">
                    <img src="./image/14.gif" alt="" class="image_con">
                    <img src="./image/15.gif" alt="" class="image_con">
                    <img src="./image/16.gif" alt="" class="image_con">
                    <img src="./image/17.gif" alt="" class="image_con">
                    <img src="./image/18.gif" alt="" class="image_con">
                    <img src="./image/19.gif" alt="" class="image_con">
                    <img src="./image/20.gif" alt="" class="image_con">
                    <img src="./image/21.gif" alt="" class="image_con">
                    <img src="./image/22.gif" alt="" class="image_con">
                    <img src="./image/23.gif" alt="" class="image_con">
                    <img src="./image/24.gif" alt="" class="image_con">
                    <img src="./image/25.gif" alt="" class="image_con">
                    <img src="./image/26.gif" alt="" class="image_con">
                    <img src="./image/27.gif" alt="" class="image_con">
                    <img src="./image/28.gif" alt="" class="image_con">
                    <img src="./image/29.gif" alt="" class="image_con">
                    <img src="./image/30.gif" alt="" class="image_con">
                    <img src="./image/31.gif" alt="" class="image_con">
                    <img src="./image/32.gif" alt="" class="image_con">
                    <img src="./image/33.gif" alt="" class="image_con">
                    <img src="./image/34.gif" alt="" class="image_con">
                    <img src="./image/35.gif" alt="" class="image_con">
                    <img src="./image/36.gif" alt="" class="image_con">
                    <img src="./image/37.gif" alt="" class="image_con">
                    <img src="./image/38.gif" alt="" class="image_con">
                    <img src="./image/39.gif" alt="" class="image_con">
                    <img src="./image/40.gif" alt="" class="image_con">
                    <img src="./image/41.gif" alt="" class="image_con">
                    <img src="./image/42.gif" alt="" class="image_con">
                    <img src="./image/43.gif" alt="" class="image_con">
                    <img src="./image/44.gif" alt="" class="image_con">
                    <img src="./image/45.gif" alt="" class="image_con">
                    <img src="./image/46.gif" alt="" class="image_con">
                    <img src="./image/47.gif" alt="" class="image_con">
                    <img src="./image/48.gif" alt="" class="image_con">
                    <img src="./image/49.gif" alt="" class="image_con">
                    <img src="./image/50.gif" alt="" class="image_con">
                    <img src="./image/51.gif" alt="" class="image_con">
                    <img src="./image/52.gif" alt="" class="image_con">
                    <img src="./image/53.gif" alt="" class="image_con">
                    <img src="./image/54.gif" alt="" class="image_con">
                    <img src="./image/55.gif" alt="" class="image_con">
                    <img src="./image/56.gif" alt="" class="image_con">
                    <img src="./image/57.gif" alt="" class="image_con">
                    <img src="./image/58.gif" alt="" class="image_con">
                    <img src="./image/59.gif" alt="" class="image_con">
                    <img src="./image/60.gif" alt="" class="image_con">
                    <img src="./image/61.gif" alt="" class="image_con">
                    <img src="./image/62.gif" alt="" class="image_con">
                    <img src="./image/63.gif" alt="" class="image_con">
                    <img src="./image/64.gif" alt="" class="image_con">
                    <img src="./image/65.gif" alt="" class="image_con">
                    <img src="./image/66.gif" alt="" class="image_con">
                    <img src="./image/67.gif" alt="" class="image_con">
                    <img src="./image/68.gif" alt="" class="image_con">
                    <img src="./image/69.gif" alt="" class="image_con">
                    <img src="./image/70.gif" alt="" class="image_con">
                    <img src="./image/71.gif" alt="" class="image_con">
                    <img src="./image/72.gif" alt="" class="image_con">
                    <img src="./image/73.gif" alt="" class="image_con">
                    <img src="./image/74.gif" alt="" class="image_con">
                    <img src="./image/75.gif" alt="" class="image_con">
                    <img src="./image/76.gif" alt="" class="image_con">
                    <img src="./image/77.gif" alt="" class="image_con">
                    <img src="./image/78.gif" alt="" class="image_con">
                    <img src="./image/79.gif" alt="" class="image_con">
                    <img src="./image/80.gif" alt="" class="image_con">
                    <img src="./image/81.gif" alt="" class="image_con">
                    <img src="./image/82.gif" alt="" class="image_con">
                    <img src="./image/83.gif" alt="" class="image_con">
                    <img src="./image/84.gif" alt="" class="image_con">
                    <img src="./image/85.gif" alt="" class="image_con">
                    <img src="./image/86.gif" alt="" class="image_con">
                    <img src="./image/87.gif" alt="" class="image_con">
                    <img src="./image/88.gif" alt="" class="image_con">
                    <img src="./image/89.gif" alt="" class="image_con">
                    <img src="./image/90.gif" alt="" class="image_con">
                    <img src="./image/91.gif" alt="" class="image_con">
                    <img src="./image/92.gif" alt="" class="image_con">
                    <img src="./image/93.gif" alt="" class="image_con">
                    <img src="./image/94.gif" alt="" class="image_con">
                    <img src="./image/95.gif" alt="" class="image_con">
                    <img src="./image/96.gif" alt="" class="image_con">
                    <img src="./image/97.gif" alt="" class="image_con">
                    <img src="./image/98.gif" alt="" class="image_con">
                    <img src="./image/99.gif" alt="" class="image_con">
                    <img src="./image/100.gif" alt="" class="image_con">
                    <img src="./image/101.gif" alt="" class="image_con">
                    <img src="./image/102.gif" alt="" class="image_con">
                    <img src="./image/103.gif" alt="" class="image_con">
                    <img src="./image/104.gif" alt="" class="image_con">
                    <img src="./image/105.gif" alt="" class="image_con">
                    <img src="./image/106.gif" alt="" class="image_con">
                    <img src="./image/107.gif" alt="" class="image_con">
                    <img src="./image/108.gif" alt="" class="image_con">
                    <img src="./image/109.gif" alt="" class="image_con">
                    <img src="./image/110.gif" alt="" class="image_con">
                    <img src="./image/111.gif" alt="" class="image_con">
                    <img src="./image/112.gif" alt="" class="image_con">
                    <img src="./image/113.gif" alt="" class="image_con">
                    <img src="./image/114.gif" alt="" class="image_con">
                    <img src="./image/115.gif" alt="" class="image_con">
                    <img src="./image/116.gif" alt="" class="image_con">
                    <img src="./image/117.gif" alt="" class="image_con">
                    <img src="./image/118.gif" alt="" class="image_con">
                    <img src="./image/119.gif" alt="" class="image_con">
                    <img src="./image/120.gif" alt="" class="image_con">
                    <img src="./image/121.gif" alt="" class="image_con">
                    <img src="./image/122.gif" alt="" class="image_con">
                    <img src="./image/123.gif" alt="" class="image_con">
                    <img src="./image/124.gif" alt="" class="image_con">
                    <img src="./image/125.gif" alt="" class="image_con">
                    <img src="./image/126.gif" alt="" class="image_con">
                    <img src="./image/127.gif" alt="" class="image_con">
                    <img src="./image/128.gif" alt="" class="image_con">
                    <img src="./image/129.gif" alt="" class="image_con">
                    <img src="./image/130.gif" alt="" class="image_con">
                    <img src="./image/131.gif" alt="" class="image_con">
                    <img src="./image/132.gif" alt="" class="image_con">
                </div>
                <div class="talk_input">
                    <input type="text" class="talk_word" id="talkwords">
                    <input type="button" value="发送信息" class="talk_sub" id="talksub">
                    <div id="image_icon">
                        <button class="talk_sub" id="talksub_img">发送表情</button>
                    </div>

                </div>
            </div>
            <!-- <div class="user_list">
                <div class="user_list_title">用户列表</div>
                <div class="user">
                    <ul>
                        <li id="user">王者</li>
                    </ul>
                </div>
            </div> -->
        </div>
    </body>
</html>

<script>
	    var username = decodeURI(location.search.split("=")[1]);/* 获取username decodeURI解码，不解会乱码中文*/
	    console.log(username)
	    var Words = document.getElementById("words");/* 显示对话 */
	    var TalkWords = document.getElementById("talkwords");/* 输入框 */
	    var TalkSub = document.getElementById("talksub");/* 发送信息按钮 */
	 
	    // var talksub_img=document.getElementById("talksub_img")/* 发送表情按钮 */
	    var image_list = document.getElementById("image_list")/* 获取图片列表 */
	    var image_icon=document.getElementById("image_icon")/* 获取表情包图片 */
	 
	    // var talk1=document.getElementById("talk1")/* 改变对话 */
	    // var talk2=document.getElementById("talk2")
	    // var talk3=document.getElementById("talk3")
	    // talk1.innerHTML='12-01 09:53:53 '+username+'说：以后请多关照'
	    // talk2.innerHTML='12-01 09:35:06 '+username+'说：大家好'
	    // talk3.innerHTML='12-01 09:53:53 服务器说：欢迎用户'+username+'光临'+username+'聊天室'
	 
	    /* var user=document.getElementById("user")/* 改变用户 */
	    // user.innerHTML=username 
	 
	    /* 表情包 */
	    var image_con=document.getElementsByClassName("image_con")
	  /*   console.log(image_con.length) */
	  /* 为每个表情包图片绑定点击事件*/
	    image_icon.onclick=function(){
	        
	        for(var i=0;i<image_con.length;i++){
	            image_con[i].num=i/* 绑定图片下标，用下标索引图片 */
	            image_con[i].onclick=function(){
	                x=this.num/* x是下标 1 2 3 */
	              /*  console.log(x) */
	              /* 点击图片发送显示的 */
	               str = '<div class="atalk"><span class="asay">'+username+'说：<img src="./image/'+(x+1)+'.gif" alt="" class="image_con"></span></div>';
	               Words.innerHTML = Words.innerHTML + str;
	            }
	    
	        }
	        /* 这里设置表情包框显示余隐藏，一开始我设置隐藏，点击就切换为显示block */
	        if(image_list.style.display=="block"){
	            image_list.style.display="none"
	            console.log(image_con.length)
	 
	        }else{
	            image_list.style.display="block"
	        }
	 
	    }
	 
	    TalkSub.onclick = function(){
	        //定义空字符串
	        var str = "";
	        if(TalkWords.value == ""){
	             // 消息为空时弹窗
	            alert("消息不能为空");
	            return;
	        }
	        
	            /* 敏感词过滤 */
	            var arr = [/靠/ig,/tmd/ig,/nm/ig,/tm/ig,/他妈的/ig];
	            for(var i=0;i<arr.length;i++){
	                /*这些if来判断敏感词的个数，i==0就是靠，就一个敏感词，所以就一个*，以此类推*/
	                if(i==0){
	                    TalkWords.value = TalkWords.value.replace(arr[i],"*");
	                }
	                if(i==1){
	                    TalkWords.value = TalkWords.value.replace(arr[i],"***");
	                }
	                if(i==2){
	                    TalkWords.value = TalkWords.value.replace(arr[i],"**");
	                }
	                if(i==3){
	                    TalkWords.value = TalkWords.value.replace(arr[i],"**");
	                }
	                if(i==4){
	                    TalkWords.value = TalkWords.value.replace(arr[i],"***");
	                }
	            }
	            /* 把输入话语拼接 */
	            str = '<div class="atalk"><span class="asay">'+username+'说 :' + TalkWords.value +'</span></div>';

	        //    发消息
            var im = goeasy.im;
            //创建消息, 内容最长不超过3K，可以发送字符串，对象和json格式字符串
            var textMessage = im.createTextMessage({
                text:str, //消息内容
                to : {
                    type : GoEasy.IM_SCENE.GROUP,   //私聊还是群聊，私聊为GoEasy.IM_SCENE.PRIVATE
                    id : 'group001',  //群id
                    data : {"avatar":"/www/xxx.png","nickname":"区块链交流群"} //群信息, 任意格式的字符串或者对象，用于更新会话列表中的群信息conversation.data
                }
            });

            //发送消息
            im.sendMessage({
                message:textMessage,
                onSuccess: function (message) {  //发送成功
                    console.log("Group message sent successfully.", message);
                },
                onFailed: function (error) { //发送失败
                    console.log("Failed to send group message, code:"+error.code+ ",error:"+error.content);
                }
            });

            /* 返回到html显示 */
	        Words.innerHTML = Words.innerHTML + str;
	        TalkWords.value=""

	    }

        let goeasy = GoEasy.getInstance({
            host:"hangzhou.goeasy.io",  //若是新加坡区域：singapore.goeasy.io
            appkey:"BC-b4c11138903e4507af9681442d8cc85a",
            modules:['im']//根据需要，传入'im’或‘pubsub’，或数组方式同时传入
        });

        //建立连接
        goeasy.connect({
            id:"001",  //im必填，最大长度60字符
            data:{"avatar":"/www/xxx.png","nickname":"Neo"}, //必须是一个对象，im必填，最大长度300字符，显示在会话列表中
            onSuccess: function () {  //连接成功
                console.log("GoEasy connect successfully.") //连接成功
            },
            onFailed: function (error) { //连接失败
                console.log("Failed to connect GoEasy, code:"+error.code+ ",error:"+error.content);
            },
            onProgress:function(attempts) { //连接或自动重连中
                console.log("GoEasy is connecting", attempts);
            }
        });


        //接收消息
        var onGroupMessageReceived = function(message) {
            //群聊消息message示例
            // {
            //     "messageId": "a5f705e0c7e111eab347b726da4416bd",
            //     "type": "text",
            //     "timestamp": 1594958255483,
            //     "senderId": "3bb179af-bcc5-4fe0-9dac-c05688484649",
            //     "senderData": {"avatar":"/www/xxx.png","nickname":"Neo"}, //发送者Data，仅限群聊消息
            //     "payload": {
            //         "text": "Hello, GoEasyIM"
            //     },
            //     "groupId": "group-a42b-47b2-bb1e-15e0f5f9a19a"
            // }
            console.log("received group message:" + JSON.stringify(message));
            console.log(message)

            /* 返回到html显示 */
            Words.innerHTML = Words.innerHTML + message.payload.text;

        };
        var im = goeasy.im;

        //接收群消息
        im.on(GoEasy.IM_EVENT.GROUP_MESSAGE_RECEIVED, onGroupMessageReceived);


        //订阅群消息
        var groupIds = ["group001"];
        im.subscribeGroup({
            groupIds:groupIds,
            onSuccess: function () {  //订阅成功
                console.log("Group message subscribe successfully.");
            },
            onFailed: function (error) { //订阅失败
                console.log("Failed to subscribe group message, code:" + error.code + " content:" + error.content);
            }
        });

</script>